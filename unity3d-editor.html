<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Unity3D Save Editor</title>
    <style>
        :root { --bg:#0d1117; --surface:#161b22; --text:#c9d1d9; --accent:#58a6ff; --border:#30363d; --success:#238636; --error:#f85149; }
        body { font-family:system-ui,sans-serif; background:var(--bg); color:var(--text); margin:0; padding:20px; }
        h1 { text-align:center; color:var(--accent); margin:0 0 30px; }
        .container { max-width:1100px; margin:0 auto; }
        .upload-zone { border:3px dashed var(--border); border-radius:12px; padding:60px 20px; text-align:center; background:var(--surface); transition:all 0.3s; cursor:pointer; }
        .upload-zone:hover, .upload-zone.dragover { border-color:var(--accent); background:#1c2330; }
        .upload-zone.dragover { border-color:var(--success); }
        #editor, #hex-view { background:var(--surface); border:1px solid var(--border); border-radius:8px; padding:20px; margin-top:25px; min-height:300px; }
        table { width:100%; border-collapse:collapse; margin:15px 0; }
        th,td { padding:12px; text-align:left; border-bottom:1px solid var(--border); }
        th { background:#0d1117; color:#8b949e; }
        input { background:#0d1117; border:1px solid var(--border); color:var(--text); padding:6px 10px; border-radius:6px; width:100%; box-sizing:border-box; }
        button { background:var(--success); color:white; border:none; padding:10px 20px; border-radius:6px; cursor:pointer; font-size:1rem; }
        button:hover { background:#2ea043; }
        .btn-save { display:block; margin:20px auto 0; }
        #status { margin-top:20px; padding:12px; border-radius:6px; }
        .success { background:#12211e; color:var(--accent); }
        .error { background:#1e1114; color:var(--error); }
        .return-home { position:fixed; top:20px; left:20px; color:var(--accent); text-decoration:none; padding:8px 16px; background:var(--surface); border:1px solid var(--border); border-radius:6px; }
        .return-home:hover { background:var(--accent); color:white; }
        .hex-table { font-family:Consolas,monospace; font-size:14px; white-space:pre; }
    </style>
</head>
<body>
    <a href="index.html" class="return-home">← 返回主页</a>

    <div class="container">
        <h1>Unity3D Save Editor (.sav / .dat)</h1>

        <div class="upload-zone" id="dropZone">
            <p>拖放或点击上传 .sav / .dat 文件</p>
            <input type="file" id="fileInput" accept=".sav,.dat" style="display:none;">
            <button onclick="document.getElementById('fileInput').click()">选择文件</button>
        </div>

        <div id="editor"></div>
        <div id="hex-view"></div>
        <div id="status"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

    <script>
        let currentData = null;
        let fileName = "";
        let isJson = false;

        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const editor = document.getElementById('editor');
        const hexView = document.getElementById('hex-view');
        const status = document.getElementById('status');

        dropZone.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', e => handleFile(e.target.files[0]));

        dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('dragover'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
        dropZone.addEventListener('drop', e => {
            e.preventDefault(); dropZone.classList.remove('dragover');
            handleFile(e.dataTransfer.files[0]);
        });

        async function handleFile(file) {
            if (!file) return;
            fileName = file.name;
            showStatus(`正在读取 ${fileName}...`, 'info');

            const buffer = await file.arrayBuffer();
            try {
                const text = new TextDecoder().decode(buffer);
                currentData = JSON.parse(text);
                isJson = true;
                renderJsonEditor();
                showStatus(`成功加载 JSON 存档！`, 'success');
            } catch {
                isJson = false;
                renderHexView(buffer);
                showStatus('非 JSON 格式，已显示十六进制视图', 'info');
            }
        }

        function renderJsonEditor() {
            editor.innerHTML = '<h3>JSON 编辑器</h3>';
            const table = document.createElement('table');
            table.innerHTML = `<thead><tr><th>键</th><th>值</th></tr></thead><tbody></tbody>`;
            const tbody = table.querySelector('tbody');

            for (const [key, value] of Object.entries(currentData)) {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${escapeHtml(key)}</td>
                    <td><input type="text" value="${escapeHtml(JSON.stringify(value))}" data-key="${key}" onchange="updateJsonValue(this)"></td>
                `;
                tbody.appendChild(tr);
            }

            editor.appendChild(table);

            const saveBtn = document.createElement('button');
            saveBtn.textContent = '保存修改';
            saveBtn.className = 'btn-save';
            saveBtn.onclick = saveJson;
            editor.appendChild(saveBtn);
        }

        window.updateJsonValue = function(input) {
            const key = input.dataset.key;
            try {
                currentData[key] = JSON.parse(input.value);
            } catch {
                currentData[key] = input.value;
            }
        };

        function saveJson() {
            const blob = new Blob([JSON.stringify(currentData, null, 2)], { type: 'application/json' });
            saveAs(blob, `edited_${fileName}`);
            showStatus('文件已保存！', 'success');
        }

        function renderHexView(buffer) {
            editor.innerHTML = '<p>非 JSON 格式存档。当前仅支持查看，未来可添加偏移编辑。</p>';
            hexView.innerHTML = '<h3>十六进制预览（前 512 字节）</h3>';
            const view = new Uint8Array(buffer.slice(0, 512));
            let hex = '';
            for (let i = 0; i < view.length; i += 16) {
                let line = `${i.toString(16).padStart(8,'0')}  `;
                for (let j = 0; j < 16; j++) {
                    const byte = view[i+j] || 0;
                    line += byte.toString(16).padStart(2,'0') + ' ';
                    if (j === 7) line += ' ';
                }
                line += ' | ';
                for (let j = 0; j < 16; j++) {
                    const byte = view[i+j] || 32;
                    line += (byte >= 32 && byte <= 126) ? String.fromCharCode(byte) : '.';
                }
                hex += line + '\n';
            }
            const pre = document.createElement('pre');
            pre.className = 'hex-table';
            pre.textContent = hex;
            hexView.appendChild(pre);
        }

        function escapeHtml(text) {
            return text.replace(/[&<>"']/g, m => ({ '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;' })[m]);
        }

        function showStatus(msg, type) {
            status.textContent = msg;
            status.className = type;
            setTimeout(() => status.textContent = '', 5000);
        }
    </script>
</body>
</html>
