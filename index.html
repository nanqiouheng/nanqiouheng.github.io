<!DOCTYPE html>
<html>
<head>
    <title>成绩计算器 - OCR优化版</title>
    <!-- 图标和其它头部内容保持不变 -->
    <style>
        /* 添加预处理画布样式 */
        #preprocess-canvas {
            display: none;
            position: absolute;
            top: -9999px;
        }
        /* 改进状态提示样式 */
        #ocr-status {
            margin: 15px 0;
            padding: 10px;
            border-radius: 5px;
            background: #f8f9fa;
            color: #0c5460;
            font-weight: normal;
        }
        .processing {
            background: #fff3cd !important;
            color: #856404 !important;
        }
        .success {
            background: #d4edda !important;
            color: #155724 !important;
        }
        .error {
            background: #f8d7da !important;
            color: #721c24 !important;
        }
        /* 其余样式保持不变 */
    </style>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
</head>
<body>
    <div class="container">
        <!-- 页面结构保持不变 -->
        <canvas id="preprocess-canvas"></canvas>
    </div>
    <script>
        // 添加图片预处理函数
        function preprocessImage(image, callback) {
            const canvas = document.getElementById('preprocess-canvas');
            const ctx = canvas.getContext('2d');
            
            // 设置canvas尺寸
            canvas.width = image.width;
            canvas.height = image.height;
            
            // 绘制原始图像
            ctx.drawImage(image, 0, 0);
            
            // 获取图像数据
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            // 图像预处理（灰度化 + 二值化）
            for (let i = 0; i < data.length; i += 4) {
                const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                const value = avg > 128 ? 255 : 0; // 简单二值化
                data[i] = value;     // R
                data[i + 1] = value; // G
                data[i + 2] = value; // B
            }
            
            ctx.putImageData(imageData, 0, 0);
            callback(canvas);
        }

        // 更新OCR识别函数
        async function recognizeImage(file) {
            const statusEl = document.getElementById('ocr-status');
            statusEl.textContent = '开始图像预处理...';
            statusEl.className = 'processing';
            
            try {
                const image = await createImageBitmap(file);
                preprocessImage(image, async (canvas) => {
                    statusEl.textContent = '正在进行文字识别...';
                    
                    // 使用最新Tesseract配置
                    const { data: { text } } = await Tesseract.recognize(
                        canvas,
                        'chi_sim+eng', // 中文简体 + 英文
                        {
                            logger: m => {
                                if(m.status === 'recognizing text') {
                                    statusEl.textContent = `识别进度: ${Math.round(m.progress*100)}%`;
                                }
                            },
                            // 优化引擎参数
                            oem: Tesseract.OEM.LSTM_ONLY,
                            psm: Tesseract.PSM.AUTO,
                            // 添加自定义配置
                            tessedit_char_whitelist: '0123456789%.abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ中文项目期中期末考试平时作业实验报告',
                        }
                    );
                    
                    statusEl.textContent = '识别完成，正在解析数据...';
                    statusEl.className = 'processing';
                    
                    // 解析识别结果
                    parseAndFillData(text);
                    
                    statusEl.textContent = `成功导入数据！`;
                    statusEl.className = 'success';
                });
            } catch (error) {
                console.error(error);
                statusEl.textContent = `识别失败: ${error.message}`;
                statusEl.className = 'error';
            }
        }

        // 增强解析逻辑
        function parseAndFillData(text) {
            console.log("识别结果:\n", text);
            
            // 改进的正则表达式，支持中文和多种分隔符
            // 格式: 项目名 权重 成绩
            // 示例: 
            // 期中考试 30% 85
            // 平时作业  20%  92.5
            const regex = /([\u4e00-\u9fa5a-zA-Z]+)\s+(\d+%?)\s+([\d\.]+)/g;
            
            const rows = [];
            let match;
            
            while ((match = regex.exec(text)) !== null) {
                const name = match[1].trim();
                let weight = match[2].trim();
                const score = match[3].trim();
                
                // 确保权重有百分号
                if (!weight.endsWith('%')) weight += '%';
                
                rows.push({
                    name,
                    weight,
                    score
                });
            }
            
            console.log("解析结果:", rows);
            
            if (rows.length > 0) {
                tableBody.innerHTML = '';
                rows.forEach(row => renderRow({
                    id: generateId(),
                    ...row
                }));
                calculateOverallScore();
            } else {
                throw new Error("未找到成绩数据");
            }
        }

        // 图片上传事件处理
        document.getElementById('image-upload').addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.type.match('image.*')) {
                alert('请上传图片文件');
                return;
            }
            
            recognizeImage(file);
            event.target.value = '';
        });

        // 其它函数保持不变...
        
        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            // 原有初始化代码...
            // 测试数据初始化
            tableBody.innerHTML = '';
            initialData.forEach(item => renderRow(item));
            calculateOverallScore();
        });
    </script>
</body>
</html>
