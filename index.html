<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>天堂聚合站 - joe666.dpdns.org</title>
    <script src="https://lf26-cdn.pubg.com/cdn/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://lf26-cdn.pubg.com/cdn/file-saver/2.0.5/FileSaver.min.js"></script>
    <style>
        :root{--main:#ff00cc;--grad:linear-gradient(45deg,#ff00cc,#9c27b0)}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:Segoe UI,Microsoft YaHei,Arial;background:linear-gradient(135deg,#1a0933,#2d1b4e);color:#fff;min-height:100vh;overflow-x:hidden}
        .header{position:fixed;top:0;width:100%;background:rgba(20,0,40,0.92);backdrop-filter:blur(15px);z-index:999;padding:15px 20px;text-align:center;box-shadow:0 8px 32px rgba(138,43,226,0.4)}
        .logo{font-size:2.5em;font-weight:bold;background:linear-gradient(90deg,#ff00cc,#00ffcc);-webkit-background-clip:text;color:transparent}
        .search{max-width:1000px;margin:90px auto 20px;padding:0 20px}
        .bar{display:flex;gap:12px;margin-bottom:20px}
        #kw{flex:1;padding:20px 25px;border:none;border-radius:50px;background:rgba(255,255,255,0.15);color:#fff;font-size:1.3em;outline:none}
        button{padding:20px 50px;border:none;border-radius:50px;background:var(--grad);color:#fff;font-size:1.3em;cursor:pointer;box-shadow:0 10px 30px rgba(156,39,176,0.6);transition:.3s}
        button:hover{transform:translateY(-4px);box-shadow:0 20px 40px rgba(156,39,176,0.8)}
        .btns{text-align:center;margin:20px 0}
        .btns button{margin:0 8px;padding:12px 30px;background:rgba(255,255,255,0.1);border:1px solid var(--main)}
        .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:20px;padding:0 15px;min-height:100vh}
        .item{position:relative;border-radius:16px;overflow:hidden;background:rgba(0,0,0,0.4);box-shadow:0 10px 30px rgba(0,0,0,0.7);transition:.4s;opacity:0;transform:translateY(20px)}
        .item.show{opacity:1;transform:none}
        .item:hover{transform:translateY(-12px);box-shadow:0 25px 50px rgba(255,0,204,0.5)}
        .item img{width:100%;height:280px;object-fit:cover;background:#111}
        .title{position:absolute;bottom:0;left:0;right:0;padding:20px 15px;background:linear-gradient(transparent,#000d);font-size:1em;line-height:1.4}
        .loading{display:none;text-align:center;padding:80px 0;font-size:1.6em}
        .spinner{width:70px;height:70px;border:8px solid rgba(255,0,204,0.3);border-top:8px solid var(--main);border-radius:50%;animation:s 1s linear infinite;margin:30px auto}
        @keyframes s{to{transform:rotate(360deg)}}
        #reader{position:fixed;top:0;left:0;width:100%;height:100%;background:#000;z-index:9999;display:none;overflow:hidden}
        #reader-header{position:fixed;top:0;left:0;right:0;height:60px;background:rgba(0,0,0,0.8);backdrop-filter:blur(10px);z-index:10;display:flex;align-items:center;justify-content:space-between;padding:0 20px}
        #close-reader{color:var(--main);font-size:2em;cursor:pointer}
        #progress-bar{height:5px;background:var(--main);width:0;position:fixed;bottom:0;left:0;z-index:10;transition:width .3s}
        #reader-content{padding:60px 0 50px;overflow-y:scroll;height:100%}
        #reader-content img{max-width:100%;display:block;margin:0 auto 10px;cursor:zoom-in;user-select:none}
        .page-num{text-align:center;color:#999;margin:10px 0;font-size:0.9em}
        footer{text-align:center;padding:50px;color:#aaa;font-size:0.9em}
    </style>
</head>
<body>

<div class="header"><div class="logo">天堂聚合站</div></div>

<div class="search">
    <div class="bar">
        <input type="text" id="kw" placeholder="输入关键词、作者、标签，直接秒搜" autofocus>
        <button onclick="debouncedSearch()">搜索</button>
    </div>
    <div class="btns">
        <button onclick="downloadAll()">整部打包下载</button>
        <button onclick="clearAll()">清空</button>
    </div>
</div>

<div class="loading" id="loading"><div class="spinner"></div><p>正在极速加载…</p></div>
<div class="grid" id="grid"></div>
<div id="progress-bar"></div>

<div id="reader">
    <div id="reader-header">
        <div id="reader-title">加载中…</div>
        <div id="close-reader" onclick="closeReader()">×</div>
    </div>
    <div id="reader-content"></div>
</div>

<footer>© 2025 天堂聚合站 • 极速资源搜索与阅读工具</footer>

<script>
    const PROXY = "https://cors-joe666.deno.dev/?u=";
    let cache = new Map();
    let currentImages = [];
    let observer, debounceTimer;

    // 防抖搜索
    const debouncedSearch = () => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(search, 600);
    };

    async function search(){
        const kw = document.getElementById("kw").value.trim() || "最新";
        if(cache.has(kw)){
            renderGrid(cache.get(kw));
            return;
        }

        document.getElementById("loading").style.display = "block";
        document.getElementById("grid").innerHTML = "";

        const urls = [
            `https://jmcomic.la/search/photos?search_query=${encodeURIComponent(kw)}`,
            `https://jmcomic.me/search/photos?search_query=${encodeURIComponent(kw)}`,
            `https://18comic.vip/search/photos?search_query=${encodeURIComponent(kw)}`
        ];

        for(let url of urls){
            try{
                const html = await fetch(PROXY + encodeURIComponent(url), {cache: "force-cache"}).then(r=>r.text());
                const items = parseJMComic(html);
                if(items.length > 0){
                    cache.set(kw, items);
                    renderGrid(items);
                    break;
                }
            }catch(e){}
        }
        document.getElementById("loading").style.display = "none";
    }

    function parseJMComic(html){
        const doc = new DOMParser().parseFromString(html, "text/html");
        const items = [];
        doc.querySelectorAll("a[href*='album'], a.video-title, .thumb a").forEach(a => {
            const img = a.querySelector("img");
            const title = (a.querySelector("h3, .video-title")?.innerText || "作品").trim().slice(0,30);
            let src = img?.getAttribute("data-original") || img?.src || "";
            if(src && src.startsWith("//")) src = "https:" + src;
            const href = a.href?.includes("http") ? a.href : "https://jmcomic.la" + a.href;

            if(src.includes("/media/photos/")){
                items.push({src, title, href});
            }
        });
        return items;
    }

    function renderGrid(items){
        const grid = document.getElementById("grid");
        const fragment = document.createDocumentFragment();

        items.forEach((item,i) => {
            const div = document.createElement("div");
            div.className = "item";
            div.innerHTML = `
                <img src="${item.src}" loading="lazy" alt="${item.title}">
                <div class="title">${item.title}</div>
            `;
            div.onclick = () => openReader(item.href);
            div.style.transitionDelay = `${i*30}ms`;
            setTimeout(() => div.classList.add("show"), 100);
            fragment.appendChild(div);
        });
        grid.appendChild(fragment);
    }

    async function openReader(url){
        document.getElementById("reader").style.display = "block";
        document.getElementById("reader-content").innerHTML = "<div class='loading'>正在加载图片…</div>";
        currentImages = [];

        try{
            const html = await fetch(PROXY + encodeURIComponent(url)).then(r=>r.text());
            const doc = new DOMParser().parseFromString(html, "text/html");
            document.getElementById("reader-title").innerText = doc.querySelector("h1, title")?.innerText.trim() || "阅读中";

            let imgs = [];
            doc.querySelectorAll("script").forEach(s => {
                if(s.innerHTML.includes("chapterImages")){
                    const m = s.innerHTML.match(/\[(.*?)\]/s);
                    if(m) imgs = JSON.parse(m[0]);
                }
            });

            if(imgs.length === 0){
                imgs = Array.from(doc.querySelectorAll("#comic-page img, img.lazy")).map(img => 
                    img.src || img.dataset.src || img.getAttribute("data-original") || ""
                ).filter(Boolean);
            }

            currentImages = imgs.map(u => u.startsWith("http") ? u : "https://jmcomic.la" + u);

            const container = document.getElementById("reader-content");
            container.innerHTML = "";
            currentImages.forEach((src,i) => {
                const img = document.createElement("img");
                img.src = src;
                img.loading = "lazy";
                img.onclick = () => img.requestFullscreen?.();
                img.onload = () => document.getElementById("progress-bar").style.width = `${(i+1)/currentImages.length*100}%`;
                container.appendChild(img);
                const p = document.createElement("div");
                p.className = "page-num";
                p.innerText = `${i+1} / ${currentImages.length}`;
                container.appendChild(p);
            });
        }catch(e){
            document.getElementById("reader-content").innerHTML = "<p style='text-align:center;padding:100px;color:#ff00cc'>加载失败，可刷新重试</p>";
        }
    }

    function closeReader(){
        document.getElementById("reader").style.display = "none";
        document.getElementById("progress-bar").style.width = "0";
    }

    function downloadAll(){
        if(currentImages.length === 0) return alert("请先打开阅读器");
        const zip = new JSZip();
        const folder = zip.folder("天堂合集");
        currentImages.forEach((url,i) => {
            fetch(url).then(r=>r.blob()).then(b=>folder.file(`${i+1}.jpg`, b));
        });
        zip.generateAsync({type:"blob"}).then(c=>saveAs(c, "天堂合集_"+Date.now()+".zip"));
    }

    function clearAll(){
        document.getElementById("grid").innerHTML = "";
        cache.clear();
    }

    document.getElementById("kw").addEventListener("input", debouncedSearch);
    document.addEventListener("keydown", e => {
        if(e.key === "Enter") debouncedSearch();
        if(e.key === "Escape" && document.getElementById("reader").style.display === "block") closeReader();
    });
</script>
</body>
</html>
