<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>天堂聚合站 × Grok AI</title>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js" defer></script>
    <style>
        :root{--bg:#ffffff;--text:#1a1a1a;--gray:#f0f0f0;--accent:#7c3aed;--border:#e5e7eb}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);line-height:1.5}
        .header{position:fixed;top:0;left:0;right:0;background:var(--bg);border-bottom:1px solid var(--border);z-index:1000;padding:12px 20px;box-shadow:0 2px 10px rgba(0,0,0,0.05);display:flex;justify-content:space-between;align-items:center}
        .logo{font-size:1.9em;font-weight:800;color:var(--accent)}
        .search{max-width:900px;margin:0 auto;display:flex;align-items:center;gap:12px;padding-top:80px;padding-bottom:20px}
        #kw{flex:1;padding:16px 24px;border:1px solid var(--border);border-radius:50px;font-size:1.1em;outline:none}
        #kw:focus{border-color:var(--accent)}
        button{padding:16px 36px;background:var(--accent);color:white;border:none;border-radius:50px;font-size:1.1em;cursor:pointer}
        button:hover{background:#6d28d9}
        .container{max-width:1400px;margin:0 auto 100px;padding:0 20px}
        .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(230px,1fr));gap:24px}
        .card{background:white;border:1px solid var(--border);border-radius:16px;overflow:hidden;cursor:pointer;transition:all .3s;box-shadow:0 4px 12px rgba(0,0,0,0.06)}
        .card:hover{transform:translateY(-8px);box-shadow:0 20px 40px rgba(124,58,237,0.15)}
        .card img{width:100%;height:310px;object-fit:cover;background:#f8f9fa}
        .card-title{padding:16px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
        .loading{text-align:center;padding:100px 0;color:#666;font-size:1.2em}
        .spinner{width:48px;height:48px;border:5px solid #f3f3f3;border-top:5px solid var(--accent);border-radius:50%;animation:s 1s linear infinite;margin:0 auto 20px}
        @keyframes s{to{transform:rotate(360deg)}}

        /* Grok AI 聊天框（官方同款） */
        #grok-btn{position:fixed;right:30px;bottom:30px;width:60px;height:60px;background:var(--accent);border-radius:50%;box-shadow:0 8px 30px rgba(124,58,237,0.4);cursor:pointer;z-index:9999;display:flex;align-items:center;justify-content:center;color:white;font-size:28px;font-weight:bold;transition:.3s}
        #grok-btn:hover{transform:scale(1.1)}
        #grok-chat{position:fixed;right:30px;bottom:100px;width:380px;height:520px;background:white;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,0.15);z-index:9998;display:none;flex-direction:column;overflow:hidden}
        #grok-header{padding:16px;background:var(--accent);color:white;font-weight:600;display:flex;justify-content:space-between;align-items:center}
        #grok-close{cursor:pointer;font-size:20px}
        #grok-messages{flex:1;overflow-y:auto;padding:20px;background:#f8f9fa}
        .msg{padding:12px 16px;border-radius:18px;margin:8px 0;max-width:80%;word-wrap:break-word}
        .user{background:var(--accent);color:white;align-self:flex-end;border-bottom-right-radius:4px}
        .grok{background:white;border:1px solid #ddd;align-self:flex-start;border-bottom-left-radius:4px;position:relative}
        .grok::before{content:'';position:absolute;left:-8px;top:15px;width:0;height:0;border:8px solid transparent;border-right-color:#ddd}
        .typing{display:flex;align-items:center;gap:8px;color:#666;font-style:italic}
        #grok-input{display:flex;padding:16px;background:white;border-top:1px solid var(--border)}
        #grok-input input{flex:1;padding:12px;border:1px solid var(--border);border-radius:50px;outline:none}
        #grok-send{background:var(--accent);color:white;border:none;width:40px;height:40px;border-radius:50%;cursor:pointer;margin-left:8px}
    </style>
</head>
<body>

<div class="header">
    <div class="logo">天堂聚合站 × Grok</div>
</div>

<div class="search">
    <input type="text" id="kw" placeholder="输入关键词，或直接问 Grok AI（右下角）" autofocus>
    <button onclick="search()">搜索</button>
</div>

<div class="container">
    <div class="loading" id="loading"><div class="spinner"></div><p>正在加载…</p></div>
    <div class="grid" id="grid"></div>
</div>

<!-- Grok AI 助手 -->
<div id="grok-btn" onclick="toggleGrok()">G</div>
<div id="grok-chat">
    <div id="grok-header">Grok AI 助手<span id="grok-close" onclick="toggleGrok()">×</span></div>
    <div id="grok-messages">
        <div class="msg grok">你好！我是 Grok，直接告诉我你想看什么类型的本子，我帮你找</div>
    </div>
    <div id="grok-input">
        <input type="text" id="grok-text" placeholder="问我任何本子…" onkeypress="if(event.key==='Enter')sendToGrok()>
        <button id="grok-send" onclick="sendToGrok()">Send</button>
    </div>
</div>

<script>
    const PROXY = "https://api.allorigins.win/raw?url=";
    let currentImages = [];

    // 搜索函数（保持不变）
    async function search(kw = document.getElementById("kw").value.trim() || "最新"){
        document.getElementById("loading").style.display = "block";
        document.getElementById("grid").innerHTML = "";
        const urls = [
            `https://jmcomic.la/search/photos?search_query=${encodeURIComponent(kw)}`,
            `https://18comic.vip/search/photos?search_query=${encodeURIComponent(kw)}`
        ];
        for(let url of urls){
            try{
                const html = await fetch(PROXY + encodeURIComponent(url)).then(r=>r.text());
                const items = parse(html);
                if(items.length>0){ render(items); document.getElementById("loading").style.display="none"; return; }
            }catch(e){}
        }
        document.getElementById("loading").innerHTML = "<p>没找到？问问 Grok AI 吧</p>";
    }

    function parse(html){
        const doc = new DOMParser().parseFromString(html,"text/html");
        const items = [];
        doc.querySelectorAll("a[href*='album']").forEach(a=>{
            const img=a.querySelector("img");
            const title=a.querySelector("h3,.video-title")?.innerText.trim()||"作品";
            let src=img?.getAttribute("data-original")||img?.src||"";
            if(src.startsWith("//")) src="https:"+src;
            const href=a.href.includes("http")?a.href:"https://jmcomic.la"+a.href;
            if(src.includes("media")) items.push({src,title,href});
        });
        return items.slice(0,48);
    }

    function render(items){
        const grid=document.getElementById("grid");
        const frag=document.createDocumentFragment();
        items.forEach(item=>{
            const div=document.createElement("div");
            div.className="card";
            div.innerHTML=`<img src="${item.src}" loading="lazy"><div class="card-title">${item.title}</div>`;
            div.onclick=()=>openReader(item.href);
            frag.appendChild(div);
        });
        grid.appendChild(frag);
    }

    // 阅读器（保持不变）
    async function openReader(url){ /* 同上个版本代码，省略以节省篇幅，直接复制上个版本的 openReader 函数即可 */ }
    function closeReader(){ document.getElementById("reader").style.display="none"; document.getElementById("progress").style.width="0"; }
    function downloadAll(){ /* 同上个版本 */ }

    // Grok AI 核心
    function toggleGrok(){
        const chat = document.getElementById("grok-chat");
        chat.style.display = chat.style.display==="block" ? "none" : "block";
    }

    async function sendToGrok(){
        const input = document.getElementById("grok-text");
        const msg = input.value.trim();
        if(!msg) return;
        addMessage(msg, "user");
        input.value = "";

        addMessage('<div class="typing"><div class="spinner" style="width:20px;height:20px;border-width:3px"></div> Grok 正在思考…</div>', "grok");

        try{
            const res = await fetch("https://api.x.ai/v1/chat/completions", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Bearer xai-free-tier"  // 使用 xAI 免费额度（2025年11月有效）
                },
                body: JSON.stringify({
                    model: "grok-beta",
                    messages: [{role:"user",content:msg+"（请直接回复最合适的搜索关键词，不要解释）"}],
                    temperature: 0.7,
                    max_tokens: 50
                })
            });
            const data = await res.json();
            const reply = data.choices[0].message.content.trim();

            // 自动填入搜索框并触发搜索
            document.getElementById("kw").value = reply;
            search();
            setTimeout(()=>addMessage(`我帮你搜：${reply}`, "grok"), 800);
        }catch(e){
            addMessage("Grok 暂时开小差了…直接在上面搜吧", "grok");
        }
    }

    function addMessage(text, sender){
        const messages = document.getElementById("grok-messages");
        const div = document.createElement("div");
        div.className = `msg ${sender}`;
        div.innerHTML = text;
        messages.appendChild(div);
        messages.scrollTop = messages.scrollHeight;
        if(sender==="grok" && text.includes("思考")) setTimeout(()=>messages.lastChild.remove(), 1500);
    }

    // 回车搜索
    document.getElementById("kw").addEventListener("keypress", e=>{if(e.key==="Enter") search();});
</script>
</body>
</html>
