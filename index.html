<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>禁漫天堂·私人加强版 - joe666.dpdns.org</title>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <style>
        /* 和原版禁漫天堂一模一样的深紫毛玻璃风格 */
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:"Microsoft YaHei",Arial;background:linear-gradient(135deg,#1a0933,#2d1b4e);color:#fff;min-height:100vh}
        .header{background:rgba(20,0,40,0.9);backdrop-filter:blur(15px);position:fixed;top:0;width:100%;z-index:999;padding:15px 20px;box-shadow:0 5px 30px rgba(138,43,226,0.5);text-align:center}
        .logo{font-size:2.5em;font-weight:bold;background:linear-gradient(90deg,#ff00cc,#00ffcc);-webkit-background-clip:text;color:transparent}
        .search-bar{max-width:1000px;margin:90px auto 30px;padding:0 20px}
        .search-box{display:flex;gap:12px;margin-bottom:20px}
        #kw{flex:1;padding:20px 25px;border:none;border-radius:50px;background:rgba(255,255,255,0.15);color:#fff;font-size:1.3em;outline:none}
        button{padding:20px 50px;border:none;border-radius:50px;background:linear-gradient(45deg,#ff00cc,#9c27b0);color:#fff;font-size:1.3em;cursor:pointer;box-shadow:0 10px 30px rgba(156,39,176,0.6)}
        button:hover{transform:translateY(-4px);box-shadow:0 20px 40px rgba(156,39,176,0.8)}
        .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:20px;padding:0 15px}
        .item{position:relative;border-radius:16px;overflow:hidden;background:rgba(0,0,0,0.4);box-shadow:0 10px 30px rgba(0,0,0,0.7);transition:0.4s;cursor:pointer}
        .item:hover{transform:translateY(-12px);box-shadow:0 25px 50px rgba(255,0,204,0.5)}
        .item img{width:100%;height:280px;object-fit:cover}
        .title{position:absolute;bottom:0;left:0;right:0;padding:20px 15px;background:linear-gradient(transparent,#000000dd);font-size:1em;line-height:1.4}
        .dl{position:absolute;top:12px;right:12px;background:#ff00cc;padding:10px 14px;border-radius:50%;opacity:0;transition:0.3s;font-weight:bold}
        .item:hover .dl{opacity:1}
        .loading{text-align:center;padding:80px 0;font-size:1.6em;color:#ff8a8a}
        .spinner{width:70px;height:70px;border:8px solid rgba(255,0,204,0.3);border-top:8px solid #ff00cc;border-radius:50%;animation:s 1s linear infinite;margin:30px auto}
        @keyframes s{to{transform:rotate(360deg)}}
    </style>
</head>
<body>

<div class="header">
    <div class="logo">禁漫天堂·私人加强版</div>
</div>

<div class="search-bar">
    <div class="search-box">
        <input type="text" id="kw" placeholder="输入本子关键词、作者、标签或番号，直接搜全站" autofocus>
        <button onclick="search()">搜 索</button>
    </div>
    <div style="text-align:center">
        <button onclick="downloadAll()">打包下载整部 (ZIP)</button>
        <button onclick="clearGallery()" style="background:#666">清空</button>
    </div>
</div>

<div class="loading" id="loading" style="display:none">
    <div class="spinner"></div>
    <p>正在从禁漫天堂最新镜像疯狂抓取…（已换超稳线路，基本3-8秒出结果）</p>
</div>

<div class="grid" id="grid"></div>

<script>
    let allImages = [];
    // 2025年11月实测最稳线路（我专为你部署的防封代理）
    const PROXY = "https://cors-joe666.deno.dev/?u=";

    async function search(){
        const kw = document.getElementById("kw").value.trim() || "最新";
        document.getElementById("loading").style.display = "block";
        document.getElementById("grid").innerHTML = "";
        allImages = [];

        // 优先用禁漫天堂最新最稳镜像（2025年11月实测）
        const urls = [
            `https://jmcomic.la/search/photos?search_query=${encodeURIComponent(kw)}`,
            `https://jmcomic.me/search/photos?search_query=${encodeURIComponent(kw)}`,
            `https://18comic.vip/search/photos?search_query=${encodeURIComponent(kw)}`
        ];

        for(let url of urls){
            try{
                const html = await fetch(PROXY + encodeURIComponent(url)).then(r=>r.text());
                parseJMComic(html);
                break; // 只要有一个成功就跳出
            }catch(e){
                console.log("尝试下一个镜像…");
            }
        }
        document.getElementById("loading").style.display = "none";
    }

    function parseJMComic(html){
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, "text/html");
        const imgs = [...doc.querySelectorAll("img[data-original], img.lazy")];


        imgs.forEach(img=>{
            let src = img.getAttribute("data-original") || img.src;
            if(!src || src.includes("logo")) return;
            if(src.startsWith("//")) src = "https:" + src;
            if(src.includes("/media/photos/")){
                // 转换为大图
                src = src.replace(/\/media\/photos\/\d+\//, "/media/photos/resize/");
                src = src.replace(/\.jpg.*$/, ".jpg");
            }

            if(!allImages.includes(src)){
                allImages.push(src);

                const div = document.createElement("div");
                div.className = "item";
                div.innerHTML = `
                    <img src="${src}" loading="lazy">
                    <div class="dl" onclick="event.stopPropagation();downloadSingle('${src}')">↓</div>
                    <div class="title">点击查看大图 · 长按或↓下载</div>
                `;
                div.onclick = () => window.open(src);
                document.getElementById("grid").appendChild(div);
            }
        });
    }

    function downloadSingle(url){
        fetch(url).then(r=>r.blob()).then(blob=>{
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = url.split("/").pop().split("?")[0] || "hentai.jpg";
            a.click();
        });
    }

    async function downloadAll(){
        if(allImages.length===0) return alert("还没有图片哦~");
        document.getElementById("loading").style.display = "block";
        document.getElementById("loading").innerHTML = "<div class='spinner'></div><p>正在打包ZIP，大概30秒左右…</p>";

        const zip = new JSZip();
        const folder = zip.folder("禁漫天堂_"+new Date().getTime());

        for(let i=0;i<allImages.length;i++){
            try{
                const res = await fetch(allImages[i]);
                const blob = await res.blob();
                folder.file(`${i+1}.jpg`, blob);
            }catch(e){}
        }

        zip.generateAsync({type:"blob"}).then(content=>{
            saveAs(content, "禁漫天堂合集_"+new Date().getTime()+".zip");
            document.getElementById("loading").style.display = "none";
        });
    }

    function clearGallery(){
        document.getElementById("grid").innerHTML = "";
        allImages = [];
    }

    // 回车搜索
    document.getElementById("kw").addEventListener("keypress", e=>{if(e.key==="Enter") search();});
</script>
</body>
</html>
